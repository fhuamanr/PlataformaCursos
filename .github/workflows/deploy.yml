name: Deploy PlataformaCursos App

on:
  push:
    branches: [master]

jobs:
  deploy:
    name: EC2 Deployment
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the code from the repository
      - uses: actions/checkout@v2

      # Step 2: Set up SSH to connect to the EC2 instance
      - name: Build and Deploy 
        env: 
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}  # Clave privada para acceder al EC2
          IP_ADDRESS: ${{ secrets.EC2_IP }}            # Dirección IP de la instancia EC2
          USER_NAME: ${{ secrets.EC2_USER }}           # Usuario para acceder al EC2
        run: |
          # Guardar la clave privada en un archivo temporal y configurar los permisos
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key

          # Conectarse a EC2 y ejecutar el proceso de despliegue
          ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${IP_ADDRESS} '

              # Cambia al directorio del proyecto en la instancia EC2
              cd /home/ec2-user/PlataformaCursos &&

              # Actualiza el código fuente desde el repositorio
              git checkout master &&
              git reset --hard origin/master &&
              git pull origin master &&

              # Activar el entorno virtual
              source /home/ec2-user/PlataformaCursos/PlataformaCursos/bin/activate &&

              # Instalar las dependencias del proyecto
              pip install -r requirements.txt &&

              # Iniciar la aplicación usando nohup con la ruta completa de manage.py
              nohup python3 /home/ec2-user/PlataformaCursos/plataforma_cursos/manage.py runserver 0.0.0.0:8000 &
          '